# Security, Validation, Error Handling, and Time Zones

## Validation and Sanitization

### Hash

Regex: `/^[a-f0-9]{64}$/`. Validated at:

- URL matching (rewrite rule restricts to `[a-f0-9]{64}`, click handler validates again)
- Cookie parsing (`Cookie_Manager::parse()`)
- REST API request (`Rest_Endpoint::set_cookie()`)
- Database lookup (must exist as a published tracking URL via `Post_Type::get_valid_hashes()`)

### UTM Parameters

**Postmeta fields (fixed per tracking URL):**

| Field | Required (admin form) | Max length | Sanitization |
|-------|----------------------|------------|--------------|
| `source` | Yes (v1.5.0+) | 255 | `sanitize_text_field()` |
| `medium` | Yes (v1.5.0+) | 255 | `sanitize_text_field()` |
| `campaign` | Yes (v1.5.0+) | 255 | `sanitize_text_field()` |

Source, medium, and campaign are required when creating a tracking URL. The click handler still attempts to populate empty values from incoming UTM/MTM parameters for backwards compatibility with pre-v1.5.0 URLs.

**Per-click fields (stored in clicks table):**

| Field | Required | Max length | Sanitization |
|-------|----------|------------|--------------|
| `content` | No | 255 | `sanitize_text_field()`, `mb_substr()` |
| `term` | No | 255 | `sanitize_text_field()`, `mb_substr()` |
| `id` | No | 255 | `sanitize_text_field()`, `mb_substr()` |
| `source_platform` (group) | No | 255 | `sanitize_text_field()`, `mb_substr()` |

All fields exceeding 255 characters are truncated via `mb_substr()`. Empty values are stored as `NULL`.

### Click ID

| Field | Max length | Sanitization |
|-------|------------|--------------|
| `click_id` | 255 | `sanitize_text_field()` |
| `platform` | 50 | Validated against registered capturers (must be a key in the capturers array) |

### Queue Payload

Payloads are stored JSON-encoded. Payloads are generated by registered reporters — the core does not validate payload contents, but `json_encode()` / `json_decode()` handles serialization safely. The reporter is responsible for the payload structure.

### Target URL

Selected via the page selector — always a valid WordPress post ID. No free-text URL. The plugin's own CPT is excluded. All public post types are searchable.

## CSRF / Nonces

- **Admin page forms (create URL, trash/restore/delete, bulk actions):** Custom nonce via `wp_nonce_field` / `wp_verify_nonce`.
- **CSV export:** Custom nonce `kntnt_ad_attr_export` (POST request).
- **REST endpoint (set-cookie):** WordPress REST nonce via `X-WP-Nonce` header.
- **REST endpoint (search-posts):** WordPress REST nonce via `X-WP-Nonce` header + `kntnt_ad_attr` capability check.

## Rate Limiting

The REST `set-cookie` endpoint is rate-limited to 10 requests per minute per IP address via a WordPress transient (`kntnt_ad_attr_rate_{$ip_hash}`). Requests exceeding the limit receive HTTP 429.

## Capability

All admin functions require `kntnt_ad_attr`. Assigned to Administrator and Editor on activation. The `search-posts` REST endpoint also requires this capability. The `set-cookie` endpoint is public (protected by nonce and rate limiting instead).

## Cookie Security

- `_ad_clicks`: `HttpOnly`, `Secure`, `SameSite=Lax`, `Path=/`. Lifetime configurable (default 90 days).
- `_ad_last_conv`: `HttpOnly`, `Secure`, `SameSite=Lax`, `Path=/`. Lifetime equals `kntnt_ad_attr_dedup_seconds` (default `0` -- cookie not written when dedup is disabled). Capped to `cookie_lifetime * DAY_IN_SECONDS`.
- `_aah_pending`: **Not** `HttpOnly` (the client script must read it), `Secure`, `SameSite=Lax`, `Path=/`. Lifetime: 60 seconds.

## Error Handling

**Principle:** The plugin must never negatively affect the visitor's experience. All errors are handled silently toward the visitor. Diagnostics are logged via `error_log()`.

| Scenario | Visitor impact | Action |
|----------|---------------|--------|
| DB error on click insert | None | `error_log`, click data is lost |
| DB error on conversion write | None | `error_log`, transaction rolled back |
| Corrupt cookie | None | Cookie is ignored (invalid format) |
| REST network error | None | Retry (max 3), then loss |
| REST 403 (nonce expired) | None | Clear sessionStorage, loss |
| REST 429 (rate limited) | None | Retry on next page load |
| Cookies blocked by browser | None | Click is logged, attribution is lost |
| Target page deleted | None | 404 response (daily cron drafts orphaned URLs) |

No admin notices for individual errors. Systematic errors (e.g., table missing) show up in the server error log and in stats displaying zero data. Admin notices are shown for bulk issues: orphaned tracking URLs (target page deleted) and trashed target pages.

## Time Zones

All timestamps are stored in UTC.

| Context | Format | Function |
|---------|--------|----------|
| Cookie `_ad_clicks` | Unix timestamp (integer) | `time()` |
| Database `clicked_at`, `converted_at` | DATETIME (UTC) | `gmdate( 'Y-m-d H:i:s' )` |
| Database `created_at`, `processed_at` | DATETIME (UTC) | `gmdate( 'Y-m-d H:i:s' )` |
| Attribution weight calculation | Difference in days | `time() - $timestamp` |
| Admin UI date filter | Local date → converted to UTC DATETIME range | `wp_timezone_string()` |
| CSV filename | Local dates as displayed in the filter | No conversion |

## General Security Rules

- All user-facing strings shall be translatable via `__()` / `_e()` / `esc_html__()`.
- All SQL queries via `$wpdb->prepare()`.
- All admin URLs via `admin_url()` / `wp_nonce_url()`.
- No direct access to `$_GET`, `$_POST`, `$_COOKIE` without sanitization.
- `sanitize_text_field()` is used for all text input from query strings and form fields.
- `absint()` is used for numeric IDs (post IDs, click IDs).
- The conversion write is wrapped in a database transaction (`START TRANSACTION` / `COMMIT` / `ROLLBACK`).
